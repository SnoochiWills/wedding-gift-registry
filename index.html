<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Wedding Gift Registry</title>
<style>
body { font-family: Arial; background: #f7f7f7; padding: 20px; text-align: center; }
h1 { color: #444; }
ul { list-style: none; padding: 0; max-width: 500px; margin: 20px auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
li { padding: 12px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
li:last-child { border-bottom: none; }
.taken { text-decoration: line-through; color: gray; }
button { padding: 5px 10px; }
</style>
</head>
<body>
<h1>Wedding Gift Registry</h1>
<p>Please choose from the list below. Items marked as <em>taken</em> are already reserved.</p>
<ul id="gift-list"></ul>

<script>
const apiUrl = "https://script.google.com/macros/s/AKfycbz7D2n8RdpkJT2eC32toFJVgMU7BzETwhQp3DdER4Y99uyS7fy1Wlr7kYY5H_0k_KDoCA/exec";
const giftList = document.getElementById("gift-list");

// Predefined gift list in case sheet is not yet updated
const gifts = [
  "Stove",
  "Fridge",
  "Stainless Steel cutlery",
  "Stainless Steel cookware",
  "Airfryer",
  "Toaster",
  "Kettle (cordless)",
  "Dinner plate/s",
  "Glasses",
  "Tea set/s",
  "Coffee mugs",
  "Stand mixer/Hand mixer",
  "Blender",
  "Deep fryer",
  "Microwave",
  "Coffee Maker",
  "Tray Cultery",
  "Pot Holders",
  "Dish Organiser",
  "Pan Organiser",
  "Utensil Organiser"
];

async function loadGifts() {
  try {
    const res = await fetch(apiUrl);
    const data = await res.json();
    giftList.innerHTML = "";

    // Map sheet data for faster lookup: gift -> {status, reservedBy}
    const sheetData = {};
    data.slice(1).forEach(row => {
      const [gift, status, reservedBy] = row;
      if (gift) sheetData[gift.trim()] = { status: status?.trim(), reservedBy: reservedBy?.trim() };
    });

    gifts.forEach((gift, i) => {
      const li = document.createElement("li");
      const sheetGift = sheetData[gift] || {};
      li.textContent = gift;

      if (sheetGift.status && sheetGift.status.toLowerCase() === "taken") {
        li.classList.add("taken");
        li.textContent += ` - Reserved by: ${sheetGift.reservedBy}`;
      } else {
        const btn = document.createElement("button");
        btn.textContent = "Reserve";
        btn.onclick = () => reserveGift(i + 2, gift); // +2 to match sheet row
        li.appendChild(btn);
      }

      giftList.appendChild(li);
    });

  } catch (err) {
    console.error("Error loading gifts:", err);
    giftList.innerHTML = "<li>Unable to load gifts. Please try again later.</li>";
  }
}

async function reserveGift(rowIndex, giftName) {
  const name = prompt(`Enter your name to reserve "${giftName}":`);
  if (!name) return;

  try {
    await fetch(apiUrl, {
      method: 'POST',
      body: JSON.stringify({ rowIndex, name })
    });
    loadGifts(); // reload list after reservation
  } catch (err) {
    alert("Error reserving gift: " + err);
  }
}

// Initial load
loadGifts();

// Refresh every 10 seconds to show live updates
setInterval(loadGifts, 10000);
</script>
</body>
</html>
